rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- ヘルパー関数 ---
    function isUserAuthenticated(userId) {
      return request.auth != null && userId == request.auth.uid;
    }

    // プロジェクトメンバーかどうかをチェックする関数
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      return request.auth != null && 
             project != null && 
             project.data.projectMembers is list && 
             request.auth.uid in project.data.projectMembers;
    }

    // 個人ワークスペース
    match /users/{userId}/{collectionId=**} {
      allow read, write: if isUserAuthenticated(userId);
    }

    // 全ユーザー情報（検索用）
    match /users/{userId} {
      allow read: if request.auth != null;
    }

    // プロジェクトコレクション
    match /projects/{projectId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // プロジェクト配下（共有スペース）
    match /projects/{projectId}/{collectionId=**} {
      allow read, write: if isProjectMember(projectId);
    }

  }
}